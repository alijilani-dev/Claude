ARG PYTHON_VERSION=3.11

# stage 1: builder stage (install dependencies)
FROM python:${PYTHON_VERSION}-alpine AS builder

WORKDIR /app

COPY pyproject.toml uv.lock ./

# install uv + dependencies (re-runs on ANY file change because of COPY above)
RUN pip install --no-cache-dir uv && uv pip install --system --no-cache -r pyproject.toml && pip uninstall -y uv

# stage 2: runtime stage (run app in production)
FROM python:${PYTHON_VERSION}-alpine

WORKDIR /app

# copy installed packages from builder stage
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

COPY main.py ./

RUN pip uninstall -y uv

ENV PYTHONUNBUFFERED=1
ENV LOGS=INFO

EXPOSE 8000

CMD ["uvicorn", "main:app", "--reload", "--host", "0.0.0.0", "--port", "8000"]