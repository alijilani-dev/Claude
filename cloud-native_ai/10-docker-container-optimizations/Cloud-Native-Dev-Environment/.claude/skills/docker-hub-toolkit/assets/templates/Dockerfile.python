# === Stage 1: Base ===
FROM python:{{PYTHON_VERSION}}-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
WORKDIR /app

# === Stage 2: Builder (Dependencies) ===
FROM base AS builder

RUN --mount=type=cache,target=/root/.cache/pip \
    --mount=type=bind,source={{DEPS_FILE}},target={{DEPS_FILE}} \
    pip install --user -r {{DEPS_FILE}}

# === Stage 3: Development/Test (Optional) ===
FROM base AS dev

COPY --from=builder /root/.local /root/.local
ENV PATH=/root/.local/bin:$PATH
COPY . .

# Run tests (uncomment as needed)
# RUN pip install --user pytest && pytest

# === Stage 4: Production ===
FROM python:{{PYTHON_VERSION}}-slim AS production

# Create non-root user
RUN adduser --disabled-password --no-create-home appuser

# Copy only runtime dependencies
COPY --from=builder /root/.local /root/.local
ENV PATH=/root/.local/bin:$PATH

# Copy application source
WORKDIR /app
COPY . .

# Switch to non-root user
USER appuser

# Expose application port
EXPOSE {{PORT}}

# Application entrypoint
CMD [{{CMD}}]
